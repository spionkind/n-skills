#!/usr/bin/env node

/**
 * update-registry.mjs
 *
 * Regenerates marketplace.json and AGENTS.md from sources.yaml.
 * Run this after sync-external.mjs or when adding native skills.
 *
 * Usage:
 *   node scripts/update-registry.mjs
 */

import { existsSync, readFileSync, writeFileSync } from "fs";
import { join, dirname } from "path";
import { fileURLToPath } from "url";
import { parse as parseYaml } from "yaml";

const __dirname = dirname(fileURLToPath(import.meta.url));
const ROOT = join(__dirname, "..");
const SOURCES_FILE = join(ROOT, "sources.yaml");
const MARKETPLACE_FILE = join(ROOT, ".claude-plugin", "marketplace.json");
const AGENTS_FILE = join(ROOT, "AGENTS.md");

console.log("ðŸ“ Updating registry files...\n");

// Read sources.yaml
if (!existsSync(SOURCES_FILE)) {
  console.error("âŒ sources.yaml not found");
  process.exit(1);
}

const sourcesContent = readFileSync(SOURCES_FILE, "utf-8");
const sources = parseYaml(sourcesContent);

// Group skills by category
const skillsByCategory = {};
const allSkills = [];

for (const skill of sources.skills || []) {
  const category = skill.target.category;
  if (!skillsByCategory[category]) {
    skillsByCategory[category] = [];
  }
  skillsByCategory[category].push(skill);
  allSkills.push(skill);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Update marketplace.json
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

console.log("ðŸ“¦ Updating marketplace.json...");

// Read existing marketplace.json to preserve version
let existingVersion = "1.0.0";
if (existsSync(MARKETPLACE_FILE)) {
  try {
    const existing = JSON.parse(readFileSync(MARKETPLACE_FILE, "utf-8"));
    if (existing.metadata?.version) {
      // Increment patch version
      const parts = existing.metadata.version.split(".");
      parts[2] = String(parseInt(parts[2] || "0", 10) + 1);
      existingVersion = parts.join(".");
    }
  } catch (e) {
    // Use default version if parsing fails
  }
}

const marketplace = {
  // NOTE: Do NOT add $schema - it triggers Claude Code's impersonation validation
  name: "n-skills",
  description:
    "Curated plugin marketplace for AI agents - works with Claude Code, Codex, and openskills",
  owner: {
    name: "Numman Ali",
    email: "numman.ali@gmail.com",
  },
  plugins: allSkills.map((skill) => ({
    name: skill.name,
    description: skill.description,
    source: "./",
    skills: [`./${skill.target.path}`],
    strict: false,
    ...(skill.source && {
      upstream: {
        repo: skill.source.repo,
        path: skill.source.path,
      },
    }),
  })),
  metadata: {
    version: existingVersion,
    generated_at: new Date().toISOString(),
    skill_count: allSkills.length,
  },
};

writeFileSync(MARKETPLACE_FILE, JSON.stringify(marketplace, null, 2) + "\n");
console.log(`   âœ… ${allSkills.length} plugins registered\n`);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Update AGENTS.md
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

console.log("ðŸ“„ Updating AGENTS.md...");

// Read existing AGENTS.md to preserve maintainer notes
let maintainerNotes = "";
if (existsSync(AGENTS_FILE)) {
  const existingContent = readFileSync(AGENTS_FILE, "utf-8");
  // Extract everything after "## Maintainer Notes" (preserves all maintainer sections)
  const maintainerMatch = existingContent.match(/\n(## Maintainer Notes[\s\S]*?)(?=\nGenerated by n-skills|$)/);
  if (maintainerMatch) {
    maintainerNotes = maintainerMatch[1];
  }
}

const skillXml = allSkills
  .map(
    (skill) => `<skill>
<name>${skill.name}</name>
<description>${skill.description}</description>
<location>${skill.target.path}</location>
<invoke>openskills read ${skill.name}</invoke>
</skill>`
  )
  .join("\n\n");

const agentsContent = `# n-skills

> Curated plugin marketplace for AI coding agents.
> https://github.com/numman-ali/n-skills

This repository contains high-quality, curated skills for AI coding agents.
Skills follow the [agentskills.io](https://agentskills.io) SKILL.md format.

## Installation

\`\`\`bash
npm i -g openskills
openskills install numman-ali/n-skills
openskills sync
\`\`\`

## Usage

When a user asks you to perform a task, check if any available skill can help.
Invoke skills using: \`openskills read <skill-name>\`

<available_skills>

${skillXml}

</available_skills>

## Categories

${Object.entries(skillsByCategory)
  .map(
    ([category, skills]) =>
      `### ${category}\n${skills.map((s) => `- **${s.name}**: ${s.description.split(". ")[0]}`).join("\n")}`
  )
  .join("\n\n")}

## Attribution

Skills may be sourced from external repositories. Check each skill's \`.source.json\` for attribution.

---

${maintainerNotes}Generated by n-skills sync. See [sources.yaml](sources.yaml) for the full skill manifest.
`;

writeFileSync(AGENTS_FILE, agentsContent);
console.log(`   âœ… ${allSkills.length} skills listed\n`);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Summary
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

console.log("ðŸ“Š Registry Summary");
console.log("â”€".repeat(40));
console.log(`   Total skills: ${allSkills.length}`);
console.log(`   Categories: ${Object.keys(skillsByCategory).length}`);
for (const [category, skills] of Object.entries(skillsByCategory)) {
  console.log(`     - ${category}: ${skills.length} skill(s)`);
}
console.log("\nâœ¨ Registry updated!\n");
